{% extends "core/base.html" %}
{% load static %}

{% block title %}Passer la commande{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Votre commande</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="order-form">
                        {% csrf_token %}

                        <!-- Informations personnelles -->
                        <h5 class="mb-3">Informations personnelles</h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label">Prénom *</label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.first_name.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label">Nom *</label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.last_name.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.email.id_for_label }}" class="form-label">Email *</label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.email.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.phone.id_for_label }}" class="form-label">Téléphone *</label>
                                {{ form.phone }}
                                {% if form.phone.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.phone.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Options de livraison -->
                        <h5 class="mb-3">Options de livraison</h5>
                        <div class="mb-4">
                            {{ form.delivery_type }}
                            {% if form.delivery_type.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.delivery_type.errors.0 }}
                            </div>
                            {% endif %}

                            <!-- Champs d'adresse conditionnels -->
                            <div id="address-fields" class="mt-3" style="display: none;">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label for="{{ form.address.id_for_label }}" class="form-label">Adresse complète
                                            *</label>
                                        {{ form.address }}
                                        {% if form.address.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.address.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.postal_code.id_for_label }}" class="form-label">Code
                                            postal</label>
                                        {{ form.postal_code }}
                                        {% if form.postal_code.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.postal_code.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label for="{{ form.city.id_for_label }}" class="form-label">Ville *</label>
                                        {{ form.city }}
                                        {% if form.city.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.city.errors.0 }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Méthode de paiement -->
                        <div id="payment-method-section">
                            <h5 class="mb-3">Méthode de paiement</h5>
                            <div class="mb-4">
                                {% for radio in form.payment_method %}
                                <div class="form-check mb-2 payment-method-option"
                                    data-payment-method="{{ radio.choice_value }}">
                                    {{ radio.tag }}
                                    <label class="form-check-label" for="{{ radio.id_for_label }}">
                                        {{ radio.choice_label }}
                                    </label>
                                </div>
                                {% endfor %}
                                {% if form.payment_method.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.payment_method.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Instructions de paiement -->
                        <div id="payment-instructions" class="mt-3 p-3 bg-light rounded">
                            <h6>Instructions de paiement :</h6>
                            <p class="mb-2">Veuillez effectuer le paiement via l'application mobile de votre choix :
                            </p>
                            <ul id="payment-details">
                                <li><strong>Lumicash</strong> : 0999 999 999</li>
                                <li><strong>EcoCash</strong> : 0888 888 888</li>
                                <li><strong>Ihela</strong> : 0777 777 777</li>
                            </ul>
                            <p class="mb-0 mt-2">Référence: <span id="payment-reference">CMD-{{ request.user.id
                                    }}-{{ "now" | date:"YmdHis" }}</span></p>
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Notes supplémentaires</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.notes.errors.0 }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-credit-card me-2"></i>Passer la commande
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Récapitulatif du panier -->
        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Récapitulatif de la commande</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for item in cart %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <h6 class="mb-0">{{ item.product.name }}</h6>
                                <small class="text-muted">Quantité: {{ item.quantity }}</small>
                            </div>
                            <span>{{ item.total_price|floatformat:2 }} $</span>
                        </li>
                        {% endfor %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <strong>Sous-total</strong>
                            <span>{{ cart.get_total_price|floatformat:2 }} $</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <strong>Livraison</strong>
                            <span>Gratuite</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <strong>Total</strong>
                            <span class="h5 mb-0 text-primary">{{ cart.get_total_price|floatformat:2 }} $</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Fonction pour gérer l'affichage des méthodes de paiement en fonction du type de livraison
    function togglePaymentMethods() {
        const deliveryType = document.querySelector('input[name="delivery_type"]:checked').value;
        const paymentMethodSection = document.getElementById('payment-method-section');

        if (deliveryType === 'retrait') {
            // Masquer complètement la section des méthodes de paiement pour le retrait en magasin
            if (paymentMethodSection) {
                paymentMethodSection.style.display = 'none';
            }
        } else {
            // Afficher la section des méthodes de paiement pour la livraison à domicile
            if (paymentMethodSection) {
                paymentMethodSection.style.display = 'block';
            }
        }
    }

    // Fonction pour gérer l'affichage des champs d'adresse
    function toggleAddressFields() {
        const selectedValue = document.querySelector('input[name="delivery_type"]:checked').value;
        const addressFields = document.getElementById('address-fields');

        if (selectedValue === 'livraison') {
            addressFields.style.display = 'block';
            // Rendre les champs obligatoires
            document.getElementById('id_address').required = true;
            document.getElementById('id_city').required = true;
        } else {
            addressFields.style.display = 'none';
            // Rendre les champs facultatifs
            document.getElementById('id_address').required = false;
            document.getElementById('id_city').required = false;
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Afficher/masquer les champs d'adresse en fonction du type de livraison
        const deliveryType = document.querySelectorAll('input[name="delivery_type"]');
        const addressFields = document.getElementById('address-fields');

        // Écouter les changements sur les boutons radio de livraison
        deliveryType.forEach(radio => {
            radio.addEventListener('change', function () {
                toggleAddressFields();
                togglePaymentMethods();
            });
        });

        // Initialiser l'état des méthodes de paiement au chargement de la page
        document.addEventListener('DOMContentLoaded', function () {
            togglePaymentMethods();
        });

        // Initialiser l'état au chargement de la page
        toggleAddressFields();

        // Générer une référence de paiement unique
        function generatePaymentReference() {
            const now = new Date();
            const timestamp = now.getFullYear().toString() +
                String(now.getMonth() + 1).padStart(2, '0') +
                String(now.getDate()).padStart(2, '0') +
                String(now.getHours()).padStart(2, '0') +
                String(now.getMinutes()).padStart(2, '0') +
                String(now.getSeconds()).padStart(2, '0');
            return `CMD-{{ request.user.id }}-${timestamp}`;
        }

        // Mettre à jour la référence de paiement
        document.getElementById('payment-reference').textContent = generatePaymentReference();
    });
</script>
{% endblock %}