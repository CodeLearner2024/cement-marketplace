{% extends 'core/base.html' %}

{% block title %}{% if form.operation_type.value == 'add' %}Ajouter{% else %}Retirer{% endif %} du stock - {{
product.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div
                    class="card-header {% if form.operation_type.value == 'add' %}bg-primary{% else %}bg-warning text-dark{% endif %}">
                    <h4 class="mb-0">
                        <i
                            class="bi {% if form.operation_type.value == 'add' %}bi-box-arrow-in-down{% else %}bi-box-arrow-up{% endif %}"></i>
                        {% if form.operation_type.value == 'add' %}Ajouter du stock{% else %}Retirer du stock{% endif %}
                        - {{ product.name }}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" id="stockForm">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Type d'opération -->
                        <div class="mb-4">
                            <label class="form-label d-block">Type d'opération</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="operation_type" value="add"
                                    id="operation_add" autocomplete="off" {% if form.operation_type.value=='add' or not
                                    form.operation_type.value %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="operation_add">
                                    <i class="bi bi-plus-lg"></i> Ajouter au stock
                                </label>

                                <input type="radio" class="btn-check" name="operation_type" value="remove"
                                    id="operation_remove" autocomplete="off" {% if form.operation_type.value=='remove'
                                    %}checked{% endif %}>
                                <label class="btn btn-outline-danger" for="operation_remove">
                                    <i class="bi bi-dash-lg"></i> Retirer du stock
                                </label>
                            </div>
                            {% if form.operation_type.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.operation_type.errors.0 }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Quantité -->
                        <div class="mb-3">
                            <label for="id_quantity" class="form-label">Quantité</label>
                            <div class="input-group">
                                {{ form.quantity }}
                                <span class="input-group-text">sacs</span>
                            </div>
                            {% if form.quantity.help_text %}
                            <div class="form-text">{{ form.quantity.help_text }}</div>
                            {% endif %}
                            {% if form.quantity.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.quantity.errors.0 }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Date d'opération -->
                        <div class="mb-3">
                            <label for="id_date_entree" class="form-label">Date de l'opération</label>
                            {{ form.date_entree }}
                            {% if form.date_entree.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.date_entree.errors.0 }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            <label for="id_notes" class="form-label">Commentaire (optionnel)</label>
                            {{ form.notes }}
                            {% if form.notes.help_text %}
                            <div class="form-text">{{ form.notes.help_text }}</div>
                            {% endif %}
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{% url 'products:stock_management' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Annuler
                            </a>

                            <div class="d-flex align-items-center">
                                <span class="me-3 text-muted">
                                    <i class="bi bi-box-seam"></i> Stock actuel:
                                    <strong>{{ product.current_stock|default:0 }} sac(s)</strong>
                                </span>
                                <button type="submit"
                                    class="btn {% if form.operation_type.value == 'add' %}btn-success{% else %}btn-warning{% endif %}">
                                    <i
                                        class="bi {% if form.operation_type.value == 'add' %}bi-plus-lg{% else %}bi-dash-lg{% endif %}"></i>
                                    {% if form.operation_type.value == 'add' %}Ajouter{% else %}Retirer{% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Mise à jour dynamique de l'interface en fonction du type d'opération
    document.addEventListener('DOMContentLoaded', function () {
        const operationAdd = document.getElementById('operation_add');
        const operationRemove = document.getElementById('operation_remove');
        const submitButton = document.querySelector('button[type="submit"]');
        const cardHeader = document.querySelector('.card-header');
        const titleIcon = document.querySelector('.card-header i.bi');
        const titleText = document.querySelector('.card-header h4');

        function updateUI() {
            if (operationAdd.checked) {
                // Mode ajout
                cardHeader.className = 'card-header bg-success text-white';
                titleIcon.className = 'bi bi-box-arrow-in-down';
                titleText.innerHTML = 'Ajouter du stock - {{ product.name }}';
                submitButton.className = 'btn btn-success';
                submitButton.innerHTML = '<i class="bi bi-plus-lg"></i> Ajouter';
            } else {
                // Mode retrait
                cardHeader.className = 'card-header bg-warning text-dark';
                titleIcon.className = 'bi bi-box-arrow-up';
                titleText.innerHTML = 'Retirer du stock - {{ product.name }}';
                submitButton.className = 'btn btn-warning';
                submitButton.innerHTML = '<i class="bi bi-dash-lg"></i> Retirer';
            }
        }

        // Écouter les changements de sélection
        operationAdd.addEventListener('change', updateUI);
        operationRemove.addEventListener('change', updateUI);

        // Initialiser l'interface
        updateUI();
    });
</script>
{% endblock %}